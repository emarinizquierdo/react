define(function(t,e,n){"use strict";var i=t("riot-observable");var r=/^.+?\/+[^\/]+/,f="EventListener",o="remove"+f,u="add"+f,s="hasAttribute",c="replace",a="popstate",h="hashchange",l="trigger",p=3,d=window,m=document,v=d.history.location||d.location,g=L.prototype,y=m&&m.ontouchstart?"touchstart":"click",b=false,w=i(),$=false,x,A,K,N,T,E=[],O=0;function S(t){return t.split(/[\/?#]/)}function k(t,e){var n=new RegExp("^"+e[c](/\*/g,"([^/?#]+?)")[c](/\.\./,".*")+"$"),i=t.match(n);if(i)return i.slice(1)}function q(t,e){var n;return function(){clearTimeout(n);n=setTimeout(t,e)}}function D(t){x=q(z,1);d[u](a,x);d[u](h,x);m[u](y,B);if(t)z(true)}function L(){this.$=[];i(this);w.on("stop",this.s.bind(this));w.on("emit",this.e.bind(this))}function P(t){return t[c](/^\/|\/$/,"")}function R(t){return typeof t=="string"}function _(t){return(t||v.href)[c](r,"")}function j(t){return A[0]=="#"?(t||v.href).split(A)[1]||"":_(t)[c](A,"")}function z(t){var e=O==0;if(p<=O)return;O++;E.push(function(){var e=j();if(t||e!=K){w[l]("emit",e);K=e}});if(e){while(E.length){E[0]();E.shift()}O=0}}function B(t){if(t.which!=1||t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;var e=t.target;while(e&&e.nodeName!="A")e=e.parentNode;if(!e||e.nodeName!="A"||e[s]("download")||!e[s]("href")||e.target&&e.target!="_self"||e.href.indexOf(v.href.match(r)[0])==-1)return;if(e.href!=v.href){if(e.href.split("#")[0]==v.href.split("#")[0]||A!="#"&&_(e.href).indexOf(A)!==0||!C(j(e.href),e.title||m.title))return}t.preventDefault()}function C(t,e){e=e||m.title;history.pushState(null,e,A+P(t));m.title=e;$=false;z();return $}g.m=function(t,e){if(R(t)&&(!e||R(e)))C(t,e);else if(e)this.r(t,e);else this.r("@",t)};g.s=function(){this.off("*");this.$=[]};g.e=function(t){this.$.concat("@").some(function(e){var n=(e=="@"?N:T)(P(t),P(e));if(typeof n!="undefined"){this[l].apply(null,[e].concat(n));return $=true}},this)};g.r=function(t,e){if(t!="@"){t="/"+P(t);this.$.push(t)}this.on(t,e)};var F=new L;var G=F.m.bind(F);G.create=function(){var t=new L;t.m.stop=t.s.bind(t);return t.m.bind(t)};G.base=function(t){A=t||"#";K=j()};G.exec=function(){z(true)};G.parser=function(t,e){if(!t&&!e){N=S;T=k}if(t)N=t;if(e)T=e};G.query=function(){var t={};v.href[c](/[?&](.+?)=([^&]*)/g,function(e,n,i){t[n]=i});return t};G.stop=function(){if(b){d[o](a,x);d[o](h,x);m[o](y,B);w[l]("stop");b=false}};G.start=function(t){if(!b){if(document.readyState=="complete")D(t);else d[u]("load",function(){setTimeout(function(){D(t)},1)});b=true}};G.base();G.parser();n.exports=G});